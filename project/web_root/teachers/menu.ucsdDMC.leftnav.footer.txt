<script>
    (function() {
        try {
            const darkKey = "ucsd_dark_mode";
            const userPref = localStorage.getItem(darkKey);
            const systemPref = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const isDark = userPref === "1" || (userPref === null && systemPref);
            if (isDark) {
                document.documentElement.classList.add('set-to-dark');
            }
        } catch (e) {
            console.warn("Failed to apply dark mode early:", e);
        }
    })();
</script>

<style>
    .student-dark-switch {
        position: relative;
        display: inline-flex;
        width: 50px;
        height: 24px;
        vertical-align: middle;
    }
    .student-dark-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    #student-dark-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: red;
        transition: 0.4s;
        border-radius: 24px;
        width: 50px;
        height: 20px;
    }
    
    #student-dark-slider::after {
        content: "Off";
        position: absolute;
        left: 26px;
        top: 1px;
        color: white;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
        transition: background-color 0.4s ease;
    }
    #student-dark-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        z-index: 100;
    }
    .student-dark-switch input:checked + #student-dark-slider {
        background-color: green;
    }
    .student-dark-switch input:checked + #student-dark-slider:before {
        transform: translateX(30px);
    }
    
    .student-dark-switch input:checked + #student-dark-slider::after {
        content: "On";
        color: black;
        left: 8px !important;
    }
    .student_details .student_details_container .student_details_info .student_details_info_name span#darkModeToggleSpan:not(:first-child) {
        width: auto !important;
        margin: 4px 10px 0
    }
    
    .student_details .student_details_container .student_details_info .student_details_info_name span#darkModeToggleSpan:not(:first-child) .student-dark-switch {
        display: inline;
    }
    
    body.set-to-dark:not(.disable-dark-mode) #darkModeToggleSpan {
        color: #cbd2d9;
    }
    body.set-to-dark:not(.disable-dark-mode) #student-dark-slider {
        background-color: #444;
    }
    body.set-to-dark:not(.disable-dark-mode) .student-dark-switch input:checked + #student-dark-slider {
        background-color: #2ecc71;
    }
    body.set-to-dark:not(.disable-dark-mode) #student-dark-slider:before {
        background-color: #fff;
    }
</style>

<script>
$j(() => {
    const darkKey = "ucsd_dark_mode";
        const shouldDisableDarkMode =
            window.location.pathname.startsWith('/admin/reports/rcBuilder/') &&
            !window.location.pathname.startsWith('/admin/reports/rcBuilder/home');

        if (shouldDisableDarkMode) {
            $j("body").addClass("disable-dark-mode");

            $j("iframe").each(function () {
                const iframe = this;
                $j(iframe).on("load", function () {
                    try {
                        const iframeBody = $j(iframe).contents().find("body");
                        iframeBody.addClass("disable-dark-mode");
                    } catch (e) {
                        console.warn("Could not access iframe:", iframe);
                    }
                });

                if (iframe.contentDocument?.readyState === "complete") {
                    try {
                        const iframeBody = $j(iframe).contents().find("body");
                        iframeBody.addClass("disable-dark-mode");
                    } catch (e) {
                        console.warn("Access denied to iframe body:", iframe);
                    }
                }
            });
        }

        function applyDarkMode() {
            const userPref = localStorage.getItem(darkKey); // "1", "0", or null
            const systemPref = window.matchMedia("(prefers-color-scheme: dark)").matches;
            const isDark = userPref === "1" || (userPref === null && systemPref);

            $j("body").toggleClass("set-to-dark", isDark);
            $j("body").toggleClass("set-to-light", !isDark);
            $j("#darkModeChbx").prop("checked", isDark);
        }

        // Apply dark mode state
        applyDarkMode();

        // React to system preference change
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
            if (localStorage.getItem(darkKey) === null) {
                applyDarkMode(); // only reapply if no user override
            }
        });
    
});
</script>