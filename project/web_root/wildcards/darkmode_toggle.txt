<script>
    (function() {
    try {
        const darkKey = "ucsd_dark_mode";
        const userPref = localStorage.getItem(darkKey);
        const systemPref = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const isDark = userPref === "1" || (userPref === null && systemPref);
        if (isDark) {
            document.documentElement.classList.add('set-to-dark');
        }
    } catch (e) {
        console.warn("Failed to apply dark mode early:", e);
    }
})();
</script>

<!-- Dark Mode Toggle Markup (only if not already present) -->
<span id="darkModeToggleSpan" style="padding-right:20px; display:none;">
    Dark:
    <label class="student-dark-switch">
        <input type="checkbox" id="darkModeChbx" name="darkModeChbx">
        <span id="student-dark-slider"></span>
    </label>
</span>

<style>
    body:not(.remove-opening-blur):not(.set-to-dark):not(.set-to-light):not(.disable-dark-mode):not(.psteacher) {
        filter: blur(6px) opacity(0);
        /*transition: filter 300ms ease;*/
    }
    .student-dark-switch {
        position: relative;
        display: inline-flex;
        width: 50px;
        height: 24px;
        vertical-align: middle;
    }
    .student-dark-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    #darkModeToggleSpan .student-dark-switch #student-dark-slider {
        margin: 0;
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: red;
        transition: 0.4s;
        border-radius: 24px;
        width: 50px;
        height: 20px;
    }
    
    #darkModeToggleSpan .student-dark-switch #student-dark-slider::after {
        content: "Off";
        position: absolute;
        left: 21px;
        top: 1px;
        color: white;
        font-size: 12px;
        font-weight: bold;
        pointer-events: none;
        transition: background-color 0.4s ease;
    }
    #darkModeToggleSpan .student-dark-switch #student-dark-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        z-index: 100;
    }
    #darkModeToggleSpan .student-dark-switch input:checked + #student-dark-slider {
        background-color: green;
    }
    #darkModeToggleSpan .student-dark-switch input:checked + #student-dark-slider:before {
        transform: translateX(30px);
    }
    
    #darkModeToggleSpan .student-dark-switch input:checked + #student-dark-slider::after {
        content: "On";
        color: black;
        left: 8px !important;
    }
    .student_details .student_details_container .student_details_info .student_details_info_name span#darkModeToggleSpan:not(:first-child) {
        width: auto !important;
        margin: 4px 10px 0
    }
    
    .student_details .student_details_container .student_details_info .student_details_info_name span#darkModeToggleSpan:not(:first-child) .student-dark-switch {
        display: inline;
    }
    
    body.set-to-dark:not(.disable-dark-mode) #darkModeToggleSpan {
        color: #cbd2d9;
    }
    body.set-to-dark:not(.disable-dark-mode) #student-dark-slider {
        background-color: #444;
    }
    body.set-to-dark:not(.disable-dark-mode) #darkModeToggleSpan .student-dark-switch input:checked + #student-dark-slider {
        background-color: #2ecc71;
    }
    body.set-to-dark:not(.disable-dark-mode) #student-dark-slider:before {
        background-color: #fff;
    }
</style>

<script>
$j(() => {
    const DARK_KEY = "ucsd_dark_mode";
    const toggleId = "#darkModeToggleSpan";

    // --- helpers ---
    function wantsDark() {
        const userPref = localStorage.getItem(DARK_KEY); // "1", "0", or null
        const systemPref = window.matchMedia("(prefers-color-scheme: dark)").matches;
        return userPref === "1" || (userPref === null && systemPref);
    }

    function applyDarkToDoc(doc, isDark) {
        try {
            const html = doc.documentElement;
            const body = doc.body;
            if (!html || !body) return;

            body.classList.toggle("set-to-dark", isDark);
            body.classList.toggle("set-to-light", !isDark);
            html.classList.toggle("set-to-dark", isDark);
            html.classList.toggle("set-to-light", !isDark);
        } catch (e) {
            // cross-origin or inaccessible — ignore
        }
    }

    function forEachSameOriginFrame(win, cb) {
        // apply to current document
        cb(win.document);

        // recurse into same-origin frames
        for (let i = 0; i < win.frames.length; i++) {
            const f = win.frames[i];
            try {
                // access .document to test same-origin
                void f.document;
                forEachSameOriginFrame(f, cb);
            } catch (e) {
                // cross-origin — skip
            }
        }
    }

    function applyDarkEverywhere() {
        const isDark = wantsDark();
        forEachSameOriginFrame(window.top || window, (doc) => applyDarkToDoc(doc, isDark));
        // keep the checkbox in sync in this top document (others don't have the toggle)
        $j("#darkModeChbx").prop("checked", isDark);
    }

    // --- one-off path where dark mode should be disabled ---
    const shouldDisableDarkMode =
        window.location.pathname.startsWith("/admin/reports/rcBuilder/") &&
        !window.location.pathname.startsWith("/admin/reports/rcBuilder/home");

    if (shouldDisableDarkMode) {
        $j("body").addClass("disable-dark-mode");

        // add the class to same-origin iframes too
        $j("iframe").each(function () {
            const iframe = this;
            $j(iframe).on("load", function () {
                try {
                    $j(iframe).contents().find("body").addClass("disable-dark-mode");
                } catch (e) {}
            });
            try {
                if (iframe.contentDocument?.readyState === "complete") {
                    $j(iframe).contents().find("body").addClass("disable-dark-mode");
                }
            } catch (e) {}
        });
    }

    // --- place toggle once ---
    if ($j(toggleId).length === 1 && !$j(toggleId).is(":visible")) {
        const insertTargets = ["#currentscope", "#tools"];
        for (const sel of insertTargets) {
            const $target = $j(sel);
            if ($target.length && !$target.find(toggleId).length) {
                $target.prepend($j(toggleId));
                break;
            }
        }
        $j(toggleId).show();
    }

    // --- initial apply across all same-origin frames ---
    applyDarkEverywhere();

    // --- toggle handler updates storage and reapplies everywhere ---
    $j("#darkModeChbx").off("change.ucsd").on("change.ucsd", function () {
        localStorage.setItem(DARK_KEY, this.checked ? "1" : "0");
        applyDarkEverywhere();
    });

    // --- react to system pref changes if no user override ---
    const mq = window.matchMedia("(prefers-color-scheme: dark)");
    mq.addEventListener("change", () => {
        if (localStorage.getItem(DARK_KEY) === null) {
            applyDarkEverywhere();
        }
    });

    // --- handle iframes added later (and on their load) ---
    const observer = new MutationObserver((muts) => {
        muts.forEach((m) => {
            m.addedNodes && m.addedNodes.forEach((node) => {
                if (node.tagName === "IFRAME" && node.id !== 'vmaDocumentBlob') {
                    const iframe = node;
                    // reduce flash until we apply classes
                    const prevVis = iframe.style.visibility || 'visible';
                    iframe.style.visibility = "hidden";
                    $j(iframe).on("load", function () {
                        try {
                            applyDarkToDoc(iframe.contentDocument, wantsDark());
                            if (shouldDisableDarkMode) {
                                $j(iframe).contents().find("body").addClass("disable-dark-mode");
                            }
                        } catch (e) {}
                        iframe.style.visibility = prevVis || "";
                    });

                    // if already loaded
                    try {
                        if (iframe.contentDocument?.readyState === "complete") {
                            applyDarkToDoc(iframe.contentDocument, wantsDark());
                            if (shouldDisableDarkMode) {
                                $j(iframe).contents().find("body").addClass("disable-dark-mode");
                            }
                            iframe.style.visibility = prevVis || "";
                        }
                    } catch (e) {
                        iframe.style.visibility = prevVis || "";
                    }
                }
            });
        });
    });
    observer.observe(document.documentElement, { childList: true, subtree: true });
});
</script>